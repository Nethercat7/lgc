<template>
	<view class="wrap">
		<u-toast ref="toast" />
		<view v-if="isLogin">
			<u-row gutter="16">
				<u-col span="12">
					<view class="u-text-center profile">
						<u-avatar :src="src" size="150"></u-avatar>
						<view class="u-font-xl">
							{{username}}
						</view>
						<view class="u-font-xl title">
							{{title}}
						</view>
						<view class="u-font-xl">
							积分：{{score}}
						</view>
					</view>
				</u-col>
			</u-row>
			<u-row gutter="16">
				<u-col span="12">
					<u-cell-group>
						<u-cell-item icon="list" title="排行榜" @click="goto('/pages/user/topRate/topRate')"></u-cell-item>
						<u-cell-item icon="file-text-fill" title="个人资料" @click="goto('/pages/user/userInfo/userInfo')"></u-cell-item>
						<u-cell-item icon="lock-fill" title="修改密码" @click="goto('/pages/user/changePwd/changePwd')"></u-cell-item>
						<u-cell-item icon="setting-fill" title="系统设置"></u-cell-item>
						<u-cell-item icon="integral-fill" title="退出登入" @click="exit"></u-cell-item>
					</u-cell-group>
				</u-col>
			</u-row>
		</view>
		<view v-if="!isLogin">
			<u-row gutter="16">
				<u-col span="12">
					<u-form label-position="top">
						<u-form-item label="用户名">
							<u-input v-model="name" />
						</u-form-item>
						<u-form-item label="密码">
							<u-input v-model="pwd" type="password" />
						</u-form-item>
					</u-form>
				</u-col>
			</u-row>
			<u-col span="12">
				<u-button type="primary" @click="login">登入</u-button>
			</u-col>
		</view>
	</view>
</template>

<script>
	import storage from "../../common/storage.js"
	export default {
		data() {
			return {
				src: 'https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1605900949663&di=3d1d282f8783f6eac45afc4f7511ed6c&imgtype=0&src=http%3A%2F%2Fpic4.zhimg.com%2F80%2Fv2-9a6828c2682d4cc28e9a24d49e87d99b_hd.jpg',
				username: 'Nethercat7',
				title: '垃圾大王',
				score: '77',
				isLogin: false,
				name: '',
				pwd: ''
			};
		},
		methods: {
			goto(url, type) {
				if (type == 'redirect') {
					uni.redirectTo({
						url: url
					})
				} else {
					uni.navigateTo({
						url: url
					})
				}
			},
			login() {
				this.$request('/user/login?name=' + this.name + '&pwd=' + this.pwd, {}, 'POST')
					.then(resp => {
						console.log(resp)
						if (resp.code === 1) {
							storage.set('token', resp.obj);
							this.isLogin=true;
						}
						this.$refs.toast.show({
							title: resp.msg,
							type: resp.type,
							position: 'top'
						})
					})
			},
			exit() {
				storage.remove('token');
				this.isLogin = false;
			}
		},
		onLoad() {
			let user = storage.getUser('token');
			if(JSON.stringify(user)=='{}'){
				this.isLogin=false;
			}else{
				this.isLogin=true;
				this.username=user.username;
			}
		}
	}
</script>

<style lang="scss">
	.profile view {
		padding: 10rpx
	}

	.title {
		color: $uni-color-success
	}
</style>
